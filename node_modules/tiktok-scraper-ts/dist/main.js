var W=Object.create;var v=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var U=n=>v(n,"__esModule",{value:!0}),a=(n,r)=>v(n,"name",{value:r,configurable:!0});var P=(n,r)=>{for(var t in r)v(n,t,{get:r[t],enumerable:!0})},L=(n,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of j(r))!q.call(n,o)&&(t||o!=="default")&&v(n,o,{get:()=>r[o],enumerable:!(e=_(r,o))||e.enumerable});return n},p=(n,r)=>L(U(v(n!=null?W(D(n)):{},"default",!r&&n&&n.__esModule?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n),F=(n=>(r,t)=>n&&n.get(r)||(t=L(U({}),r,1),n&&n.set(r,t),t))(typeof WeakMap!="undefined"?new WeakMap:0);var B={};P(B,{Music:()=>w,TTScraper:()=>m,TikTokResult:()=>b,User:()=>I,Video:()=>g,fetchAllVideosFromUser:()=>G,fetchMusic:()=>z,fetchUser:()=>Y,fetchVideo:()=>J,fetchVideoNoWaterMark:()=>H,hashtag:()=>K});var S=p(require("cheerio")),x=p(require("miniget")),T=p(require("node-fetch")),c=require("fs"),E=p(require("puppeteer")),R=p(require("http")),N=p(require("https")),V=require("process");var I=class{constructor(r,t,e,o,i,s,d,h,l,f,M,k,y,C,A){this.id=r,this.uniqueId=t,this.nickname=e,this.avatar=o,this.signature=i,this.createdAt=s,this.verified=d,this.secretUID=h,this.bioLink=l,this.privateAccount=f,this.isUnderAge18=M,this.followers=k,this.following=y,this.hearts=C,this.videos=A}};a(I,"User");var b=class{constructor(r,t,e,o,i,s,d,h,l,f){this.author=r,this.video=t,this.audio=e,this.shareCount=o,this.likesCount=i,this.commentCount=s,this.playCount=d,this.createdAt=h,this.tiktokLink=l,this.thumbnail=f}};a(b,"TikTokResult");var g=class{constructor(r,t,e,o,i,s,d,h,l,f,M,k,y,C,A,$,O){this.id=r,this.description=t,this.createdAt=e,this.height=o,this.width=i,this.duration=s,this.resolution=d,this.shareCount=h,this.likesCount=l,this.commentCount=f,this.playCount=M,this.downloadURL=k,this.cover=y,this.dynamicCover=C,this.playURL=A,this.format=$,this.author=O}};a(g,"Video");var w=class{constructor(r,t,e,o,i,s,d,h,l){this.id=r,this.title=t,this.playURL=e,this.coverLarge=o,this.coverThumb=i,this.author=s,this.duration=d,this.original=h,this.album=l}};a(w,"Music");var m=class{constructor(r){this._cookies="";this._cookies=r}async requestWebsite(r,t){let e=new R.default.Agent({keepAlive:!0,maxSockets:20}),o=new N.default.Agent({keepAlive:!0,maxSockets:20}),i={agent:l=>l.protocol=="http:"?e:o,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",Connection:"keep-alive",Cookie:`${this._cookies}`}},d=await(await(0,T.default)(`${r}`,t||i)).text();return S.load(d,{xmlMode:!0})}extractJSONObject(r){let t=r.split('<script id="SIGI_STATE" type="application/json">')[1].indexOf("<\/script>");return r.split('<script id="SIGI_STATE" type="application/json">')[1].slice(0,t)}checkJSONExisting(r){try{return!!JSON.parse(r)}catch{}}async requestWithPuppeteer(r){let t=await E.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]}),o=await(await t.newPage()).goto(r);if(o==null)throw new Error("Could not load the desired Page!");let i=await o.text();return await t.close(),this.extractJSONObject(i)}handleHTMLContent(r){let t=r,e=t.split("window['SIGI_STATE']=")[1].indexOf(";window['SIGI_RETRY']=");return JSON.parse(t.split("window['SIGI_STATE']=")[1].slice(0,e))}async TryFetch(r){let t=await this.requestWebsite(r);if(this.checkJSONExisting(t("#SIGI_STATE").text()))return JSON.parse(t("#SIGI_STATE").text());{let e=await this.requestWithPuppeteer(r);return JSON.parse(e)}}async video(r,t){if(!r)throw new Error("A video URL must be provided");let e=await this.TryFetch(r),o=e.ItemList.video.list[0],i=t?await this.noWaterMark(e.ItemModule[o].video.id):e.ItemModule[o].video.downloadAddr.trim();return new g(e.ItemModule[o].video.id,e.ItemModule[o].desc,new Date(Number(e.ItemModule[o].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[o].video.height),Number(e.ItemModule[o].video.width),Number(e.ItemModule[o].video.duration),e.ItemModule[o].video.ratio,e.ItemModule[o].stats.shareCount,e.ItemModule[o].stats.diggCount,e.ItemModule[o].stats.commentCount,e.ItemModule[o].stats.playCount,i,e.ItemModule[o].video.cover,e.ItemModule[o].video.dynamicCover,i,e.ItemModule[o].video.format,e.ItemModule[o].nickname)}async user(r){if(!r)throw new Error("Please enter a username");let t=await this.TryFetch(`https://www.tiktok.com/@${r}`),e=t.UserModule.users[r];return new I(e.id,e.uniqueId,e.nickname,e.avatarLarger,e.signature.trim(),new Date(e.createTime*1e3).toLocaleDateString(),e.verified,e.secUid,e?.bioLink?.link,e.privateAccount,e.isUnderAge18,t.UserModule.stats[r].followerCount,t.UserModule.stats[r].followingCount,t.UserModule.stats[r].heart,t.UserModule.stats[r].videoCount)}async getAllVideosFromUser(r,t){if(!r)throw new Error("You must provide a username!");let e=await this.TryFetch(`https://www.tiktok.com/@${r}`),o=[],{ItemList:i}=e;for(let s of i["user-post"].list){let d=t?await this.noWaterMark(e.ItemModule[s].video.id):e.ItemModule[s].video.downloadAddr.trim();o.push(new g(e.ItemModule[s].video.id,e.ItemModule[s].desc,new Date(Number(e.ItemModule[s].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[s].video.height),Number(e.ItemModule[s].video.width),Number(e.ItemModule[s].video.duration),e.ItemModule[s].video.ratio,e.ItemModule[s].stats.shareCount,e.ItemModule[s].stats.diggCount,e.ItemModule[s].stats.commentCount,e.ItemModule[s].stats.playCount,d,e.ItemModule[s].video.cover,e.ItemModule[s].video.dynamicCover,d,e.ItemModule[s].video.format,e.ItemModule[s].author))}return o}async getMusic(r){if(!r)throw new Error("You must provide a link!");let t=await this.TryFetch(r),e=t.ItemList.video.list[0];return new w(t.ItemModule[e].music.id,t.ItemModule[e].music.title,t.ItemModule[e].music.playUrl,t.ItemModule[e].music.coverLarge,t.ItemModule[e].music.coverThumb,t.ItemModule[e].music.authorName,Number(t.ItemModule[e].music.duration),t.ItemModule[e].music.original,t.ItemModule[e].music.album)}async downloadAllVideosFromUser(r,t){if(!r)throw new Error("Please enter a username!");let e=await this.getAllVideosFromUser(r);if(!e)throw new Error("No Videos were found for this username. Either the videos are private or the user has not videos");if(!t.path){if(t.path=`${__dirname}/../${r}`,(0,c.existsSync)(t.path)){console.log("A folder with this username exists, that is unusual!");try{(0,c.unlinkSync)(t.path)}catch(o){console.log(`[ERROR] Could not remove ${t.path}
 Error Message: ${o.message}`),(0,V.exit)(1)}}(0,c.existsSync)(t.path)||(0,c.mkdirSync)(t.path)}if(!t.watermark){for(let[o,i]of e.entries()){console.log(`Downloading Video: ${i.description?i.description:i.id}, [${o+1}/${e.length}]`);let s=await this.noWaterMark(i.id);if(!s){console.log(`Could not fetch ${i.description?i.description:i.id} with no watermark`);continue}(0,x.default)(s).pipe((0,c.createWriteStream)(`${t.path}/${i.id}_${i.resolution}.${i.format}`))}return}for(let[o,i]of e.entries())console.log(`Downloading Video: ${i.description?i.description:i.id}, [${o+1}/${e.length}]`),(0,x.default)(i.downloadURL).pipe((0,c.createWriteStream)(`${t.path}/${i.id}_${i.resolution}.${i.format}`))}async noWaterMark(r){let t="";r.startsWith("https")?t=(await this.video(r)).id:t=r;let o=await(await(0,T.default)("https://api2.musical.ly/aweme/v1/aweme/detail/?aweme_id="+t)).json();if(!o)throw new Error("There was an Error retrieveing this video without watermark!");let i=o.aweme_detail.video.play_addr;if(!i)throw new Error("There was an Error retrieveing this video without watermark!");return i.url_list[0]}async hashTag(r){if(!r)throw new Error("You must provide a tag name to complete the search!");let t=await this.TryFetch(`https://www.tiktok.com/tag/${r}`),{ItemList:e}=t,o=[];for(let i of e.challenge.list)o.push(new g(t.ItemModule[i].video.id,t.ItemModule[i].desc,new Date(Number(t.ItemModule[i].createTime)*1e3).toLocaleDateString(),Number(t.ItemModule[i].video.height),Number(t.ItemModule[i].video.width),Number(t.ItemModule[i].video.duration),t.ItemModule[i].video.ratio,t.ItemModule[i].stats.shareCount,t.ItemModule[i].stats.diggCount,t.ItemModule[i].stats.commentCount,t.ItemModule[i].stats.playCount,t.ItemModule[i].video.downloadAddr.trim(),t.ItemModule[i].video.cover,t.ItemModule[i].video.dynamicCover,t.ItemModule[i].video.playAddr.trim(),t.ItemModule[i].video.format,t.ItemModule[i].author));return o}};a(m,"TTScraper");async function J(n,r){if(!n)throw new Error("You must provide a Tiktok video url!");return await new m().video(n,r)}a(J,"fetchVideo");async function Y(n){if(!n)throw new Error("You must provide a username!");return await new m().user(n)}a(Y,"fetchUser");async function G(n,r){if(!n)throw new Error("You must provide a username!");return await new m().getAllVideosFromUser(n,r)}a(G,"fetchAllVideosFromUser");async function z(n){if(!n)throw new Error("You must provide a Tiktok video url!");return await new m().getMusic(n)}a(z,"fetchMusic");async function H(n){if(!n)throw new Error("You must provide a Tiktok video url!");return await new m().noWaterMark(n)}a(H,"fetchVideoNoWaterMark");async function K(n){if(!n)throw new Error("You must provide a tiktok hashtag");return await new m().hashTag(n)}a(K,"hashtag");module.exports=F(B);0&&(module.exports={Music,TTScraper,TikTokResult,User,Video,fetchAllVideosFromUser,fetchMusic,fetchUser,fetchVideo,fetchVideoNoWaterMark,hashtag});

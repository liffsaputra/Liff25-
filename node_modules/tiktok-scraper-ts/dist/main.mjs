var R=Object.defineProperty;var a=(s,r)=>R(s,"name",{value:r,configurable:!0});import{fileURLToPath as N}from"url";import V from"path";var $=a(()=>N(import.meta.url),"getFilename"),O=a(()=>V.dirname($()),"getDirname"),u=O();import*as U from"cheerio";import C from"miniget";import x from"node-fetch";import{createWriteStream as A,existsSync as T,mkdirSync as W,unlinkSync as _}from"node:fs";import*as L from"puppeteer";import j from"node:http";import D from"node:https";import{exit as P}from"node:process";var I=class{constructor(r,t,e,o,i,n,m,h,l,p,f,v,b,M,k){this.id=r,this.uniqueId=t,this.nickname=e,this.avatar=o,this.signature=i,this.createdAt=n,this.verified=m,this.secretUID=h,this.bioLink=l,this.privateAccount=p,this.isUnderAge18=f,this.followers=v,this.following=b,this.hearts=M,this.videos=k}};a(I,"User");var y=class{constructor(r,t,e,o,i,n,m,h,l,p){this.author=r,this.video=t,this.audio=e,this.shareCount=o,this.likesCount=i,this.commentCount=n,this.playCount=m,this.createdAt=h,this.tiktokLink=l,this.thumbnail=p}};a(y,"TikTokResult");var g=class{constructor(r,t,e,o,i,n,m,h,l,p,f,v,b,M,k,S,E){this.id=r,this.description=t,this.createdAt=e,this.height=o,this.width=i,this.duration=n,this.resolution=m,this.shareCount=h,this.likesCount=l,this.commentCount=p,this.playCount=f,this.downloadURL=v,this.cover=b,this.dynamicCover=M,this.playURL=k,this.format=S,this.author=E}};a(g,"Video");var w=class{constructor(r,t,e,o,i,n,m,h,l){this.id=r,this.title=t,this.playURL=e,this.coverLarge=o,this.coverThumb=i,this.author=n,this.duration=m,this.original=h,this.album=l}};a(w,"Music");var c=class{constructor(r){this._cookies="";this._cookies=r}async requestWebsite(r,t){let e=new j.Agent({keepAlive:!0,maxSockets:20}),o=new D.Agent({keepAlive:!0,maxSockets:20}),i={agent:l=>l.protocol=="http:"?e:o,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.134 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",Connection:"keep-alive",Cookie:`${this._cookies}`}},m=await(await x(`${r}`,t||i)).text();return U.load(m,{xmlMode:!0})}extractJSONObject(r){let t=r.split('<script id="SIGI_STATE" type="application/json">')[1].indexOf("<\/script>");return r.split('<script id="SIGI_STATE" type="application/json">')[1].slice(0,t)}checkJSONExisting(r){try{return!!JSON.parse(r)}catch{}}async requestWithPuppeteer(r){let t=await L.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]}),o=await(await t.newPage()).goto(r);if(o==null)throw new Error("Could not load the desired Page!");let i=await o.text();return await t.close(),this.extractJSONObject(i)}handleHTMLContent(r){let t=r,e=t.split("window['SIGI_STATE']=")[1].indexOf(";window['SIGI_RETRY']=");return JSON.parse(t.split("window['SIGI_STATE']=")[1].slice(0,e))}async TryFetch(r){let t=await this.requestWebsite(r);if(this.checkJSONExisting(t("#SIGI_STATE").text()))return JSON.parse(t("#SIGI_STATE").text());{let e=await this.requestWithPuppeteer(r);return JSON.parse(e)}}async video(r,t){if(!r)throw new Error("A video URL must be provided");let e=await this.TryFetch(r),o=e.ItemList.video.list[0],i=t?await this.noWaterMark(e.ItemModule[o].video.id):e.ItemModule[o].video.downloadAddr.trim();return new g(e.ItemModule[o].video.id,e.ItemModule[o].desc,new Date(Number(e.ItemModule[o].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[o].video.height),Number(e.ItemModule[o].video.width),Number(e.ItemModule[o].video.duration),e.ItemModule[o].video.ratio,e.ItemModule[o].stats.shareCount,e.ItemModule[o].stats.diggCount,e.ItemModule[o].stats.commentCount,e.ItemModule[o].stats.playCount,i,e.ItemModule[o].video.cover,e.ItemModule[o].video.dynamicCover,i,e.ItemModule[o].video.format,e.ItemModule[o].nickname)}async user(r){if(!r)throw new Error("Please enter a username");let t=await this.TryFetch(`https://www.tiktok.com/@${r}`),e=t.UserModule.users[r];return new I(e.id,e.uniqueId,e.nickname,e.avatarLarger,e.signature.trim(),new Date(e.createTime*1e3).toLocaleDateString(),e.verified,e.secUid,e?.bioLink?.link,e.privateAccount,e.isUnderAge18,t.UserModule.stats[r].followerCount,t.UserModule.stats[r].followingCount,t.UserModule.stats[r].heart,t.UserModule.stats[r].videoCount)}async getAllVideosFromUser(r,t){if(!r)throw new Error("You must provide a username!");let e=await this.TryFetch(`https://www.tiktok.com/@${r}`),o=[],{ItemList:i}=e;for(let n of i["user-post"].list){let m=t?await this.noWaterMark(e.ItemModule[n].video.id):e.ItemModule[n].video.downloadAddr.trim();o.push(new g(e.ItemModule[n].video.id,e.ItemModule[n].desc,new Date(Number(e.ItemModule[n].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[n].video.height),Number(e.ItemModule[n].video.width),Number(e.ItemModule[n].video.duration),e.ItemModule[n].video.ratio,e.ItemModule[n].stats.shareCount,e.ItemModule[n].stats.diggCount,e.ItemModule[n].stats.commentCount,e.ItemModule[n].stats.playCount,m,e.ItemModule[n].video.cover,e.ItemModule[n].video.dynamicCover,m,e.ItemModule[n].video.format,e.ItemModule[n].author))}return o}async getMusic(r){if(!r)throw new Error("You must provide a link!");let t=await this.TryFetch(r),e=t.ItemList.video.list[0];return new w(t.ItemModule[e].music.id,t.ItemModule[e].music.title,t.ItemModule[e].music.playUrl,t.ItemModule[e].music.coverLarge,t.ItemModule[e].music.coverThumb,t.ItemModule[e].music.authorName,Number(t.ItemModule[e].music.duration),t.ItemModule[e].music.original,t.ItemModule[e].music.album)}async downloadAllVideosFromUser(r,t){if(!r)throw new Error("Please enter a username!");let e=await this.getAllVideosFromUser(r);if(!e)throw new Error("No Videos were found for this username. Either the videos are private or the user has not videos");if(!t.path){if(t.path=`${u}/../${r}`,T(t.path)){console.log("A folder with this username exists, that is unusual!");try{_(t.path)}catch(o){console.log(`[ERROR] Could not remove ${t.path}
 Error Message: ${o.message}`),P(1)}}T(t.path)||W(t.path)}if(!t.watermark){for(let[o,i]of e.entries()){console.log(`Downloading Video: ${i.description?i.description:i.id}, [${o+1}/${e.length}]`);let n=await this.noWaterMark(i.id);if(!n){console.log(`Could not fetch ${i.description?i.description:i.id} with no watermark`);continue}C(n).pipe(A(`${t.path}/${i.id}_${i.resolution}.${i.format}`))}return}for(let[o,i]of e.entries())console.log(`Downloading Video: ${i.description?i.description:i.id}, [${o+1}/${e.length}]`),C(i.downloadURL).pipe(A(`${t.path}/${i.id}_${i.resolution}.${i.format}`))}async noWaterMark(r){let t="";r.startsWith("https")?t=(await this.video(r)).id:t=r;let o=await(await x("https://api2.musical.ly/aweme/v1/aweme/detail/?aweme_id="+t)).json();if(!o)throw new Error("There was an Error retrieveing this video without watermark!");let i=o.aweme_detail.video.play_addr;if(!i)throw new Error("There was an Error retrieveing this video without watermark!");return i.url_list[0]}async hashTag(r){if(!r)throw new Error("You must provide a tag name to complete the search!");let t=await this.TryFetch(`https://www.tiktok.com/tag/${r}`),{ItemList:e}=t,o=[];for(let i of e.challenge.list)o.push(new g(t.ItemModule[i].video.id,t.ItemModule[i].desc,new Date(Number(t.ItemModule[i].createTime)*1e3).toLocaleDateString(),Number(t.ItemModule[i].video.height),Number(t.ItemModule[i].video.width),Number(t.ItemModule[i].video.duration),t.ItemModule[i].video.ratio,t.ItemModule[i].stats.shareCount,t.ItemModule[i].stats.diggCount,t.ItemModule[i].stats.commentCount,t.ItemModule[i].stats.playCount,t.ItemModule[i].video.downloadAddr.trim(),t.ItemModule[i].video.cover,t.ItemModule[i].video.dynamicCover,t.ItemModule[i].video.playAddr.trim(),t.ItemModule[i].video.format,t.ItemModule[i].author));return o}};a(c,"TTScraper");async function Ce(s,r){if(!s)throw new Error("You must provide a Tiktok video url!");return await new c().video(s,r)}a(Ce,"fetchVideo");async function xe(s){if(!s)throw new Error("You must provide a username!");return await new c().user(s)}a(xe,"fetchUser");async function Ae(s,r){if(!s)throw new Error("You must provide a username!");return await new c().getAllVideosFromUser(s,r)}a(Ae,"fetchAllVideosFromUser");async function Te(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new c().getMusic(s)}a(Te,"fetchMusic");async function Ue(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new c().noWaterMark(s)}a(Ue,"fetchVideoNoWaterMark");async function Le(s){if(!s)throw new Error("You must provide a tiktok hashtag");return await new c().hashTag(s)}a(Le,"hashtag");export{w as Music,c as TTScraper,y as TikTokResult,I as User,g as Video,Ae as fetchAllVideosFromUser,Te as fetchMusic,xe as fetchUser,Ce as fetchVideo,Ue as fetchVideoNoWaterMark,Le as hashtag};
